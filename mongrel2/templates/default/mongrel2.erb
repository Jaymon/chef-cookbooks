#! /bin/bash
# custom init.d script for mongrel2

CHDIR="<%= @base_dir %>"
DB="<%= @conf_db %>"
RUNDIR="<%= @run_dir %>"

# returns whether the name $1 is running by checking the pid file in RUNDIR
function is_running() {
  if [[ -f "$RUNDIR"/"$1".pid ]]; then
    pid=$(cat "$RUNDIR"/"$1".pid)
    if [[ -n "$pid" ]]; then
      if [[ $(ps -p $pid > /dev/null; echo $?) -eq 0 ]]; then
        # running, pid file exists and there is a process with the pid
        return 0
      fi
    fi

  fi

  # not running
  return 1

}

function run_cmd() {
  run_raw_cmd "$@" > /var/log/syslog 2>&1
}

function run_raw_cmd() {
  cwd=$PWD
  cd "$CHDIR"
  m2sh $1 -db "$DB" -name $2 
  cd "$cwd"
}

# Exit immediately if a command exits with a non-zero status.
set -e

case "$1" in
  
  start)
    <% @names.each do |name| %>
      NAME=<%= name %>
      echo -n "Starting $NAME..."
      run_cmd "start" $NAME
      echo "done."
    <% end %>
  ;;
  
  stop)
    <% @names.each do |name| %>
      NAME=<%= name %>
      echo -n "Stopping $NAME..."
      if is_running $NAME; then
        run_cmd "stop" $NAME
        echo "done."
      else
        echo "not running"
      fi
    <% end %>
  ;;
  
  reload|force-reload)
    <% @names.each do |name| %>
      NAME=<%= name %>
      echo -n "Reloading $NAME..."
      if is_running $NAME; then
        run_cmd "reload" $NAME
      else
        run_cmd "start" $NAME
      fi
      echo "done."
    <% end %>
  ;;
  
  restart)
    <% @names.each do |name| %>
      NAME=<%= name %>
      echo -n "Restarting $NAME..."
      if is_running $NAME; then
        run_cmd "stop" $NAME
      fi
      run_cmd "start" $NAME
      echo "done."
    <% end %>
  ;;
  
  status)
    <% @names.each do |name| %>
      NAME=<%= name %>
      run_raw_cmd "running" $NAME
    <% end %>
  ;;

  *)    
    echo "Usage: /etc/init.d/$NAME {start|stop|restart|reload|status}" >&2
    exit 1
  ;;
    
esac

exit 0
